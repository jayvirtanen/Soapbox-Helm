"use strict";(self.webpackChunksoapbox_fe=self.webpackChunksoapbox_fe||[]).push([[33],{529:function(t,e,n){n.r(e),n.d(e,{default:function(){return k}});var o=n(1019),r=n(4),i=n(1018),a=(n(1),n(53),n(1797)),c=n(1017),u=n(1021),s=n(2),l=n(333),f=n(37),p=n(334),h=n(678),d=n(19),_=n(112),g=n.n(_),v=function(){return window.ethereum},m=n(10),b=n(426),w=n(13);function y(t,e){return function(n,o){if((0,b.t)(t).noApps)return new Promise((function(t){return t({})}));var r=(0,m.N$)(t).scopes,i={client_name:g().displayName,redirect_uris:"".concat(window.location.origin,"/auth/external"),website:g().homepage,scopes:r};return n((0,l.ri)(i,e))}}function S(t){return function(e,n){var o=(0,d.R3)(t)||(0,d.R3)("https://".concat(t));return function(t){return(0,w.nF)(null,t).get("/api/v1/instance").then((function(t){var e=t.data;return(0,h.VF)(e)})).catch((function(t){var e;if(401===(null===(e=t.response)||void 0===e?void 0:e.status))return(0,h.VF)({});throw t}))}(o).then((function(t){var n=(0,m.N$)(t),r=(0,b.t)(t);return n.ethereumLogin&&r.noOAuthForm?e(function(t,e){return function(n,o){return function(t){return v().request({method:"eth_requestAccounts"}).then((function(t){return t[0]})).then((function(e){return function(t,e){return v().request({method:"personal_sign",params:[e,t]})}(e,t).then((function(t){return{wallet:e,signature:t}}))}))}(t.get("login_message")).then((function(o){var r=o.wallet,i=o.signature;return n(y(t,e)).then((function(o){var a={grant_type:"ethereum",wallet_address:r.toLowerCase(),client_id:o.client_id,client_secret:o.client_secret,password:i,redirect_uri:"urn:ietf:wg:oauth:2.0:oob",scope:(0,m.N$)(t).scopes};return n((0,p.eQ)(a,e)).then((function(t){return n((0,f.oe)(t))})).then((function(t){var o=t.access_token;return n((0,f.TK)(o,e))})).then((function(t){return n((0,f.yD)(t.id))})).then((function(){return window.location.href="/"}))}))}))}}(t,o)):e(function(t,e){return function(n,o){var r=(0,m.N$)(t).scopes;return n(y(t,e)).then((function(t){var n=t.client_id,o=t.redirect_uri,i=new URLSearchParams({client_id:n,redirect_uri:o,response_type:"code",scope:r});localStorage.setItem("soapbox:external:app",JSON.stringify(t)),localStorage.setItem("soapbox:external:baseurl",e),localStorage.setItem("soapbox:external:scopes",r),window.location.href="".concat(e,"/oauth/authorize?").concat(i.toString())}))}}(t,o))}))}}var x,Z,O=n(1259),L=n(28),P=(x=function(t,e){return x=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},x(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}x(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),C=(0,a.vU)({instanceLabel:{id:"login.fields.instance_label",defaultMessage:"Instance"},instancePlaceholder:{id:"login.fields.instance_placeholder",defaultMessage:"example.com"}}),N=(0,s.$j)()(Z=(0,c.ZP)(Z=function(t){function e(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var o=t.apply(this,e)||this;return(0,i.Z)(o,"state",{host:"",isLoading:!1}),(0,i.Z)(o,"handleHostChange",(function(t){var e=t.target;o.setState({host:e.value})})),(0,i.Z)(o,"handleSubmit",(function(t){var e=o.props.dispatch,n=o.state.host;o.setState({isLoading:!0}),e(S(n)).then((function(){return o.setState({isLoading:!1})})).catch((function(){return o.setState({isLoading:!1})}))})),o}return P(e,t),e.prototype.componentDidMount=function(){var t=new URLSearchParams(window.location.search).get("code");t&&(this.setState({code:t}),this.props.dispatch(function(t){return function(e,n){var o=JSON.parse(localStorage.getItem("soapbox:external:app")),r=o.client_id,i=o.client_secret,a=o.redirect_uri,c=localStorage.getItem("soapbox:external:baseurl"),u={client_id:r,client_secret:i,redirect_uri:a,grant_type:"authorization_code",scope:localStorage.getItem("soapbox:external:scopes"),code:t};return e((0,p.eQ)(u,c)).then((function(t){return e((0,f.oe)(t))})).then((function(t){var n=t.access_token;return e((0,f.TK)(n,c))})).then((function(t){return e((0,f.yD)(t.id))})).then((function(){return window.location.href="/"}))}}(t)))},e.prototype.render=function(){var t=this.props.intl,e=this.state,n=e.isLoading;return e.code?(0,o.Z)(O.Z,{}):(0,o.Z)(L.NA,{onSubmit:this.handleSubmit,className:"external-login"},void 0,(0,o.Z)("fieldset",{disabled:n},void 0,(0,o.Z)(L.H_,{},void 0,(0,o.Z)(L.oi,{label:t.formatMessage(C.instanceLabel),placeholder:t.formatMessage(C.instancePlaceholder),name:"host",value:this.state.host,onChange:this.handleHostChange,autoComplete:"off",autoCorrect:"off",autoCapitalize:"off",required:!0}))),(0,o.Z)("div",{className:"actions"},void 0,(0,o.Z)("button",{name:"button",type:"submit",className:"btn button button-primary"},void 0,(0,o.Z)(u.Z,{id:"login.log_in",defaultMessage:"Log in"}))))},e}(r.ZP))||Z)||Z,j=function(){var t=function(e,n){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},t(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),I=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return j(e,t),e.prototype.render=function(){return(0,o.Z)(N,{})},e}(r.ZP),k=I}}]);
//# sourceMappingURL=external_login-af88b70ee3e0a8e255e4.chunk.js.map